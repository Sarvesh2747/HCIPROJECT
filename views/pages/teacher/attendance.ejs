<%- include('../../partials/header', { title: 'Mark Attendance' }) %>

<h1 class="text-3xl font-bold mb-6">Mark Attendance</h1>

<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
    <!-- Step 1: Select Batch and Date -->
    <form action="/teacher/attendance" method="GET">
        <div class="grid md:grid-cols-3 gap-4 items-end">
            <div>
                <label for="batch_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Batch</label>
                <select id="batch_id" name="batch_id" class="w-full px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600" required>
                    <option value="">-- Choose a Batch --</option>
                    <% if (typeof batches !== 'undefined' && batches.length > 0) { %>
                        <% batches.forEach(batch => { %>
                            <option value="<%= batch.id %>" <%= (typeof selectedBatchId !== 'undefined' && batch.id == selectedBatchId) ? 'selected' : '' %>)
                            >
                                <%= batch.name %>
                            </option>
                        <% }) %>
                    <% } %>
                </select>
            </div>
            <div>
                <label for="date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Date</label>
                <input type="date" id="date" name="date" value="<%= typeof selectedDate !== 'undefined' ? selectedDate : new Date().toISOString().split('T')[0] %>" class="w-full px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600" required>
            </div>
            <div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Fetch Students</button>
            </div>
        </div>
    </form>

    <% if (typeof students !== 'undefined') { %>
        <hr class="my-6 border-gray-200 dark:border-gray-700">
        <!-- Step 2: Mark Attendance for Students -->
        <h2 class="text-2xl font-bold mb-4">Students for <%= new Date(selectedDate).toDateString() %></h2>
        <% if (students.length > 0) { %>
            <form action="/teacher/attendance/mark" method="POST">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="batch_id" value="<%= selectedBatchId %>">
                <input type="hidden" name="date" value="<%= selectedDate %>">
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roll No.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <% students.forEach(student => { %>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap"><%= student.roll_no %></td>
                                    <td class="px-6 py-4 whitespace-nowrap"><%= student.name %></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <input type="hidden" name="students[<%= student.id %>][student_id]" value="<%= student.id %>">
                                        <div class="flex items-center">
                                            <label class="mr-4">
                                                <input type="radio" name="students[<%= student.id %>][status]" value="PRESENT" class="mr-1" <%= (!student.status || student.status === 'PRESENT') ? 'checked' : '' %>> Present
                                            </label>
                                            <label>
                                                <input type="radio" name="students[<%= student.id %>][status]" value="ABSENT" class="mr-1" <%= student.status === 'ABSENT' ? 'checked' : '' %>> Absent
                                            </label>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>

                <div class="mt-6">
                    <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Submit Attendance</button>
                </div>
            </form>
        <% } else { %>
            <p class="text-center text-gray-500 mt-4">No students are enrolled in this batch.</p>
        <% } %>
    <% } %>
</div>

<%- include('../../partials/footer') %>
